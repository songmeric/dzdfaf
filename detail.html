{% extends 'base.html' %}{% block title %}Run {{ id }}{% endblock %}
{% block content %}
<style>
  .pill { display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .5rem; border-radius:999px; background:var(--bs-tertiary-bg); border:1px solid var(--bs-border-color); font-size:.85rem; }
  .pill .label { color:var(--bs-secondary-color); }
  .pill .value { font-weight:600; }
  .metric-row { display:flex; flex-wrap:wrap; gap:.5rem .75rem; }

  .delta-chip { padding:.25rem .5rem; border-radius:.5rem; font-weight:600; display:inline-flex; gap:.35rem; align-items:center; border:1px solid var(--bs-border-color); }
  /* All OK = green; WATCH = brighter orange */
  .delta-down    { color:#0f5132; background:#d1e7dd; }   /* OK (green) */
  .delta-watch   { color:#7a4100; background:#ffdd99; }   /* WATCH (bright orange) */
  .delta-unknown { color:var(--bs-secondary-color); background:var(--bs-tertiary-bg); }  /* n/a */

  .card-clean { border:1px solid var(--bs-border-color); border-radius:.5rem; }
  .card-clean .card-header { background:transparent; border-bottom:1px solid var(--bs-border-color); }
</style>

<div class="d-flex justify-content-between align-items-start mb-3">
  <div>
    <h4 class="mb-1">Run {{ id }}</h4>
    <div class="text-muted small">{{ created_at[:19] }} UTC
      {% if approved %}· <span class="text-success">APPROVED</span>
      {% else %}· <span class="text-danger">PENDING</span>{% endif %}
    </div>
    <!-- Key metrics -->
    <div class="metric-row mt-2">
      <span class="pill" data-bs-toggle="tooltip" title="50th percentile of latency (median)">
        <span class="label">P50</span><span class="value">{{ '%.0f'|format(p50) }} ns</span>
      </span>
      <span class="pill" data-bs-toggle="tooltip" title="95th percentile of latency">
        <span class="label">P95</span><span class="value">{{ '%.0f'|format(p95) }} ns</span>
      </span>
      <span class="pill" data-bs-toggle="tooltip" title="99th percentile of latency">
        <span class="label">P99</span><span class="value">{{ '%.0f'|format(p99) }} ns</span>
      </span>
      <span class="pill" data-bs-toggle="tooltip" title="Population standard deviation">
        <span class="label">σ</span><span class="value">{{ '%.0f'|format(stdev) }} ns</span>
      </span>
      <span class="pill" data-bs-toggle="tooltip" title="Total samples">
        <span class="label">n</span><span class="value">{{ count }}</span>
      </span>
    </div>
  </div>

  <!-- Baseline + Filter selectors -->
  <div class="d-flex flex-column gap-2 align-items-stretch">
    <div>
      <label class="form-label mb-1">Baseline</label>
      <select id="baselineSelect" class="form-select form-select-sm" style="min-width: 300px;">
        <option value="" {% if not baseline_default %}selected{% endif %}>— none —</option>
        {% for r in baseline_runs %}
          <option value="{{ r.id }}" {% if baseline_default and r.id == baseline_default %}selected{% endif %}>
            {{ r.id }} · {{ r.created_at[:19] }} UTC{% if r.approved %} ✓{% endif %}
          </option>
        {% endfor %}
      </select>
      <div class="form-text">Used for CDF overlay and deltas.</div>
    </div>
    <div>
      <label class="form-label mb-1">Filter</label>
      <select id="filterSelect" class="form-select form-select-sm" style="min-width: 300px;"></select>
      <div class="form-text" id="filterHelp"></div>
    </div>
  </div>
</div>

<!-- Compact, labeled delta summary -->
<div id="delta-summary" class="row g-2 mb-3" style="display:none;">
  <div class="col-12 col-md-auto"><span class="text-muted">Δ vs baseline (advisory):</span></div>
  <div class="col-auto"><span class="delta-chip" id="d-p50">Δ P50</span></div>
  <div class="col-auto"><span class="delta-chip" id="d-p95">Δ P95</span></div>
  <div class="col-auto"><span class="delta-chip" id="d-p99">Δ P99</span></div>
  <div class="col-auto"><span class="delta-chip" id="d-p999">Δ P99.9</span></div>
  <div class="col-auto"><span class="delta-chip" id="d-or">Δ Outliers</span></div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs" id="viewTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-cdf" data-bs-toggle="tab" data-bs-target="#pane-cdf" type="button" role="tab">Distribution (CDF)</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-quant" data-bs-toggle="tab" data-bs-target="#pane-quant" type="button" role="tab">Per-second Quantiles</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-raw" data-bs-toggle="tab" data-bs-target="#pane-raw" type="button" role="tab">Raw Messages</button>
  </li>
</ul>

<div class="tab-content">
  <div class="tab-pane fade show active" id="pane-cdf" role="tabpanel" aria-labelledby="tab-cdf">
    <div id="cdfplot" style="height:380px;"></div>
    <div class="d-flex align-items-center gap-3 mt-2">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="toggleBaselineCDF" checked>
        <label class="form-check-label" for="toggleBaselineCDF">Overlay baseline on CDF</label>
      </div>
      <div class="small text-muted" id="cdfNote"></div>
    </div>
  </div>
  <div class="tab-pane fade" id="pane-quant" role="tabpanel" aria-labelledby="tab-quant">
    <div id="quantplot" style="height:360px;"></div>
    <div class="form-text">Quantiles and CDF are computed on the <b>filtered</b> series (raw shown below).</div>
  </div>
  <div class="tab-pane fade" id="pane-raw" role="tabpanel" aria-labelledby="tab-raw">
    <div id="rawplot" style="height:360px;"></div>
    <div class="form-text">Dense time series for shape only; not used for approval.</div>
  </div>
</div>

<!-- Indicators -->
<div class="card card-clean mt-4">
  <div class="card-header"><strong>Stability & tail indicators</strong></div>
  <div class="card-body">
    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3" id="current-stats"></div>
    <details class="mt-2">
      <summary class="small text-muted">Definitions</summary>
      <ul class="small mb-0">
        <li><b>P99.9</b>: 99.9th percentile of latency.</li>
        <li><b>MADN</b>: 1.4826 × median absolute deviation (robust scale).</li>
        <li><b>IQR</b>: interquartile range (Q3 − Q1).</li>
        <li><b>Outliers (%)</b>: share flagged by a robust rule (|x−median|/MADN &gt; 3.5).</li>
      </ul>
    </details>
  </div>
</div>

<!-- Interpretation guide -->
<div class="card card-clean mt-4">
  <div class="card-header"><strong>Interpretation guide (advisory)</strong></div>
  <div class="card-body">
    <div class="row row-cols-1 g-3">
      <div>
        <table class="table table-sm">
          <thead class="table-light">
            <tr><th>Metric</th><th>Warn if</th></tr>
          </thead>
          <tbody id="guide-table"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Approval actions -->
{% if approved %}
  <div class="alert alert-success mt-4 d-flex justify-content-between align-items-center">
    <span>Approved by <b>{{ approved_by }}</b> at {{ approved_at[:19] }} UTC</span>
    <form action="/runs/{{ id }}/unapprove" method="post">
      <button class="btn btn-outline-danger btn-sm" data-bs-toggle="tooltip" title="Mark this run as not approved">Un-approve</button>
    </form>
  </div>
{% else %}
  <form class="mt-4" action="/runs/{{ id }}/approve" method="post">
    <div class="input-group w-auto">
      <input class="form-control form-control-sm" name="user" placeholder="Your name">
      <button class="btn btn-success btn-sm">Approve</button>
    </div>
  </form>
{% endif %}

<script>
  // ---------- Constants & config
  const RULES = {{ rules_json|safe }};
  const FILTER_INFO = {{ filter_info_json|safe }};
  const FILTER_MODE_DEFAULT = FILTER_INFO.mode || 'light';
  const FILTER_DESCR = {
    "none": "No filtering (decision metrics = raw).",
    "light": "Drop negative latencies and first 300 ms warmup.",
    "strict": "Light + robust outlier removal (MAD Z > 7) and longer warmup."
  };

  const fmtInt = (v)=> (v===null||v===undefined || isNaN(v)) ? '–' : Math.round(v).toLocaleString('en');
  const fmtNs  = (v)=> (v===null||v===undefined || isNaN(v)) ? '–' : Math.round(v).toLocaleString('en') + ' ns';
  const fmtPct = (v)=> (v===null||v===undefined || isNaN(v)) ? '–' : v.toFixed(2) + ' %';

  function makeLayout(title, xTitle, yTitle){
    const cs = getComputedStyle(document.body);
    const color = cs.color || '#212529';
    return {
      title, paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)',
      font:{color},
      margin:{l:40,r:20,t:40,b:40},
      xaxis:{title:xTitle, type:'date'},
      yaxis:{title:yTitle}
    };
  }
  function makeLayoutXY(title, xTitle, yTitle){
    const cs = getComputedStyle(document.body);
    const color = cs.color || '#212529';
    return {
      title, paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)',
      font:{color},
      margin:{l:40,r:20,t:40,b:40},
      xaxis:{title:xTitle},
      yaxis:{title:yTitle}
    };
  }

  // ---------- Filter UI
  (function initFilterUI(){
    const sel = document.getElementById('filterSelect');
    ['none','light','strict'].forEach(m=>{
      const opt = document.createElement('option');
      opt.value = m; opt.textContent = m;
      if (m === FILTER_MODE_DEFAULT) opt.selected = true;
      sel.appendChild(opt);
    });
    const help = document.getElementById('filterHelp');
    help.innerHTML = `Using <b>${FILTER_MODE_DEFAULT}</b> filter · ${FILTER_DESCR[FILTER_MODE_DEFAULT]}<br><span class="small">n=${FILTER_INFO.n_used.toLocaleString()} (dropped ${FILTER_INFO.dropped.toLocaleString()} of ${FILTER_INFO.n_raw.toLocaleString()})</span>`;
    sel.addEventListener('change', ()=>{
      const m = sel.value;
      const url = new URL(window.location.href);
      url.searchParams.set('filter', m);
      window.location.replace(url.toString());
    });
  })();

  // ---------- Current-run indicators (filtered)
  (function renderCurrentStats(){
    const s = {{ stats_json|safe }};
    const items = [
      {k:'p999',lbl:'P99.9',fmt:fmtNs, tip:'99.9th percentile'},
      {k:'madn',lbl:'MADN',  fmt:fmtNs, tip:'1.4826 × MAD'},
      {k:'iqr', lbl:'IQR',   fmt:fmtNs, tip:'Q3 − Q1'},
      {k:'outlier_rate',lbl:'Outliers (%)',fmt:(v)=>fmtPct((v||0)*100), tip:'Robust outlier share'},
      {k:'mean',lbl:'Mean',fmt:fmtNs, tip:'Arithmetic mean'},
      {k:'stdev',lbl:'σ',fmt:fmtNs, tip:'Population standard deviation'},
      {k:'min',lbl:'Min',fmt:fmtNs, tip:'Minimum'},
      {k:'max',lbl:'Max',fmt:fmtNs, tip:'Maximum'},
    ];
    const box = document.getElementById('current-stats');
    items.forEach(it=>{
      const v = s[it.k]; const val = it.fmt(v);
      const div = document.createElement('div');
      div.innerHTML = `
        <div class="border rounded p-2 h-100" data-bs-toggle="tooltip" title="${it.tip}">
          <div class="text-muted small">${it.lbl}</div>
          <div class="fw-semibold">${val}</div>
        </div>`;
      box.appendChild(div);
    });
    if (window.bootstrap){
      [...document.querySelectorAll('[data-bs-toggle="tooltip"]')]
        .forEach(el=>new bootstrap.Tooltip(el));
    }
  })();

  // ---------- Interpretation guide table (warn only)
  (function renderGuide(){
    const tbody = document.getElementById('guide-table');
    const rows = [
      ['p50',  'P50'], ['p95','P95'], ['p99','P99'], ['p999','P99.9'], ['outlier_rate','Outlier rate']
    ];
    rows.forEach(([k,label])=>{
      const r = RULES[k];
      const warn = r.unit==='pp' ? `${r.warn} pp` : `${r.warn}%`;
      const floor = (k==='outlier_rate')
        ? ((r.min_pp!=null)? ` · min ${r.min_pp} pp` : '')
        : ((r.min_abs_ns!=null)? ` · min ${r.min_abs_ns} ns` : '');
      const z = (r.z_warn!=null) ? ` · z≥${r.z_warn}` : '';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${label}</td><td>+${warn}${floor}${z}</td>`;
      tbody.appendChild(tr);
    });
  })();

  // ---------- CDF (current + optional baseline overlay), filtered
  const CURRENT_CDF = { p: {{ cdf_p_json|safe }}, q_ns: {{ cdf_q_json|safe }}, run_id: "{{ id }}" };
  let baselineCDF = null;

  function renderCDF(){
    const showBaseline = document.getElementById('toggleBaselineCDF').checked;
    const data = [{
      x: CURRENT_CDF.q_ns, y: CURRENT_CDF.p.map(p=>p*100),
      name: `${CURRENT_CDF.run_id}`, mode:'lines'
    }];
    if (baselineCDF && showBaseline){
      data.push({
        x: baselineCDF.q_ns, y: baselineCDF.p.map(p=>p*100),
        name: `${baselineCDF.run_id} (baseline)`, mode:'lines', line:{dash:'dot'}
      });
    }
    Plotly.react('cdfplot', data, makeLayoutXY('Latency distribution (CDF, filtered)','Latency (ns)','Cumulative (%)'));
    const note = document.getElementById('cdfNote');
    note.textContent = `Filter=${FILTER_MODE_DEFAULT}. Baseline overlay uses the same filter.`;
  }

  // Ensure toggle works
  document.getElementById('toggleBaselineCDF').addEventListener('change', renderCDF);

  // ---------- Quantiles & Raw (render on first tab show for sizing)
  let quantReady=false, rawReady=false;
  document.getElementById('viewTabs').addEventListener('shown.bs.tab', (e)=>{
    const id = e.target.getAttribute('data-bs-target');
    if (id === '#pane-quant' && !quantReady){
      Plotly.newPlot('quantplot', [
        {x:{{ sec_json|safe }}, y:{{ p50_json|safe }}, name:'P50', mode:'lines'},
        {x:{{ sec_json|safe }}, y:{{ p95_json|safe }}, name:'P95', mode:'lines'},
        {x:{{ sec_json|safe }}, y:{{ p99_json|safe }}, name:'P99', mode:'lines'}
      ], makeLayout('Per-second quantiles (filtered)','Time (1-s buckets)','Latency (ns)'));
      quantReady=true;
    }
    if (id === '#pane-raw' && !rawReady){
      Plotly.newPlot('rawplot', [{x:{{ x_json|safe }}, y:{{ y_json|safe }}, mode:'lines', line:{width:1}}],
        makeLayout('Latency per message (raw)','Ingress time','Latency (ns)'));
      rawReady=true;
    }
  });

  // ---------- Baseline selection + deltas (all OK = green; WATCH = orange)
  function chip(el, text, cls){ el.textContent = text; el.className = `delta-chip ${cls}`; }

  function severityFor(metricKey, delta, sig){
    const r = RULES[metricKey] || {};
    if (!delta) return {level:'unknown'};

    // Absolute floors
    let absOK = true;
    if (metricKey === 'outlier_rate' && r.min_pp!=null){
      const delta_pp = Math.abs((delta.abs||0)*100);
      absOK = delta_pp >= r.min_pp;
    } else if (r.min_abs_ns!=null){
      absOK = Math.abs(delta.abs||0) >= r.min_abs_ns;
    }

    // Percent threshold (warn only)
    const pctAbs = Math.abs(delta.pct==null ? 0 : delta.pct);
    const pctOK = pctAbs >= (r.warn ?? Infinity);

    // Significance gate (percentile metrics)
    let z = null, zOK = true;
    if (sig && typeof sig.z === 'number' && r.z_warn!=null){
      z = Math.abs(sig.z);
      zOK = z >= r.z_warn;
    }

    const passWarn = absOK && pctOK && zOK;
    return {level: passWarn ? 'watch' : 'ok', z, pctAbs};
  }

  function paintDelta(elId, metricKey, delta, sig){
    const el = document.getElementById(elId);
    if (!delta){ chip(el, `${RULES[metricKey].label}: n/a`, 'delta-unknown'); return; }

    const pctText = (delta.pct==null || isNaN(delta.pct)) ? '' : ` (${delta.pct.toFixed(2)}%)`;
    const absVal = metricKey==='outlier_rate' ? (delta.abs*100).toFixed(2) + ' pp'
                                              : Math.round(delta.abs) + ' ns';

    const sev = severityFor(metricKey, delta, sig);
    const cls = (sev.level==='watch') ? 'delta-watch' : 'delta-down'; // all OK = green
    const statusLabel = (sev.level==='watch') ? 'WATCH' : 'OK';
    const zTxt = (sig && typeof sig.z === 'number') ? ` • z=${Math.abs(sig.z).toFixed(2)}` : '';

    chip(el, `Δ ${RULES[metricKey].label}: ${absVal}${pctText} • ${statusLabel}${zTxt}`, cls);
  }

  async function updateComparison(baselineId){
    const summary = document.getElementById('delta-summary');
    if (!baselineId){
      baselineCDF = null; renderCDF(); summary.style.display='none';
      return;
    }
    baselineCDF = await (await fetch(`/runs/${baselineId}/cdf_json?points=300&filter=${FILTER_MODE_DEFAULT}`)).json();
    renderCDF();

    const cmp = await (await fetch(`/runs/{{ id }}/compare?baseline_id=${baselineId}&filter=${FILTER_MODE_DEFAULT}`)).json();
    summary.style.display='flex';

    paintDelta('d-p50',  'p50',  cmp.delta.p50,  cmp.significance.p50);
    paintDelta('d-p95',  'p95',  cmp.delta.p95,  cmp.significance.p95);
    paintDelta('d-p99',  'p99',  cmp.delta.p99,  cmp.significance.p99);
    paintDelta('d-p999', 'p999', cmp.delta.p999, cmp.significance.p999);
    paintDelta('d-or',   'outlier_rate', cmp.delta.outlier_rate, null);
  }

  const selBaseline = document.getElementById('baselineSelect');
  selBaseline.addEventListener('change', (e)=> updateComparison(e.target.value));

  // Initial render
  (async function init(){
    renderCDF();
    {% if baseline_default %}
      await updateComparison("{{ baseline_default }}");
    {% endif %}
  })();
</script>
{% endblock %}
